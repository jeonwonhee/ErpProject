<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.classLink.model.mapper.DeviceMapper">
    <resultMap id="deviceResultMap" type="Device">
        <result column="DEVICE_ID" property="deviceId"/>
        <result column="DEVICE_KIND" property="deviceKind"/>
        <result column="DEVICE_COUNT" property="deviceCount"/>
        <result column="STATUS" property="status"/>
        <result column="DEVICE_REMAIN" property="deviceRemain"/>
    </resultMap>

    <resultMap id="deviceLogResultMap" type="DeviceLog">
        <result column="DEVICE_LOG_NO" property="deviceLogId"/>
        <result column="DEVICE_CNT" property="deviceGiveCount"/>
        <result column="CREATE_DATE" property="createTime"/>
        <result column="RETURN_DATE" property="returnTime"/>
        <result column="MEMBER_NO" property="memberId"/>
        <result column="RENT_ATT_NO" property="rentDeviceId"/>
        <result column="DEVICE_KIND" property="deviceKind"/>
        <result column="DEVICE_COUNT" property="deviceCount"/> <!-- int로 맞춤 -->
        <result column="REMAIN_COUNT" property="remainCount"/>
    </resultMap>



    <resultMap id="deviceRentAttResultMap" type="DeviceRentAtt">
        <result column="RENT_ATT_NO" property="deviceRentAttId"/>
        <result column="CREATE_DATE" property="createTime"/>
        <result column="START_DATE" property="startTime"/>
        <result column="END_DATE" property="endTime"/>
        <result column="UPDATE_DATE" property="updateTime"/>
        <result column="ATTEND_COUNT" property="attendAmount"/>
        <result column="STATUS" property="status"/>
        <result column="DEVICE_ID" property="deviceId"/>
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="DEVICE_KIND" property="deviceKind"/>
        <result column="MEMBER_NAME" property="memberName"/>
    </resultMap>

    <resultMap id="deviceStatusResultMap" type="Device">
        <id property="deviceId" column="DEVICE_ID"/>
        <result property="deviceKind" column="DEVICE_KIND"/>
        <result property="deviceCount" column="DEVICE_COUNT"/>
        <result property="status" column="STATUS"/>
        <result property="deviceRemain" column="DEVICE_REMAIN"/>
    </resultMap>

    <resultMap id="getDeviceRentAttById" type="DeviceRentAtt">
        <result property="attendAmount" column="ATTEND_COUNT"/>
        <result property="deviceId" column="DEVICE_ID"/>
        <result property="memberNo" column="MEMBER_NO"/>
    </resultMap>

    <resultMap id="getDeviceById" type="Device">
        <result property="deviceRemain" column="DEVICE_REMAIN"/>
    </resultMap>


    <insert id="insertDevice" parameterType="Device">
        <selectKey keyProperty="deviceId" resultType="_int" order="BEFORE">
            SELECT SEQ_DNO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO DEVICE(
        DEVICE_ID,
        DEVICE_KIND,
        DEVICE_COUNT,
        DEVICE_REMAIN
        ) VALUES(
        #{deviceId},
        #{deviceKind},
        #{deviceCount},
        #{deviceCount}
        )
    </insert>

    <select id="selectDevice" resultMap="deviceResultMap">
        SELECT DEVICE_ID,
        DEVICE_KIND,
        DEVICE_COUNT,
        STATUS
        FROM DEVICE
        WHERE STATUS = 'NORMAL'
        AND DEVICE_COUNT > 0
    </select>

    <select id="selectDeviceLogs" resultMap="deviceLogResultMap">
        SELECT
        dl.DEVICE_LOG_NO,
        dl.DEVICE_CNT,
        dl.CREATE_DATE,
        dl.RETURN_DATE,
        dl.MEMBER_NO,
        dl.RENT_ATT_NO,
        d.DEVICE_KIND,
        d.DEVICE_COUNT,
        (d.DEVICE_COUNT - NVL((SELECT SUM(dl2.DEVICE_CNT)
        FROM DEVICE_LOG dl2
        WHERE dl2.RENT_ATT_NO = dl.RENT_ATT_NO), 0)) AS REMAIN_COUNT
        FROM DEVICE_LOG dl
        JOIN DEVICE_RENT_ATT dra ON dl.RENT_ATT_NO = dra.RENT_ATT_NO
        JOIN DEVICE d ON dra.DEVICE_ID = d.DEVICE_ID


    </select>

    <select id="selectDeviceRentAtt" resultMap="deviceRentAttResultMap">
        SELECT
        A.RENT_ATT_NO,        -- DeviceRentAttId
        A.CREATE_DATE,        -- CreateTime
        A.START_DATE,         -- StartTime
        A.END_DATE,           -- EndTime
        A.UPDATE_DATE,        -- UpdateTime
        A.ATTEND_COUNT,       -- AttendAmount
        A.STATUS,             -- Status
        A.DEVICE_ID,          -- DeviceId (외래키)
        A.MEMBER_NO,          -- MemberId (외래키)
        D.DEVICE_KIND         -- deviceKind
        FROM DEVICE_RENT_ATT A
        JOIN DEVICE D ON A.DEVICE_ID = D.DEVICE_ID
        ORDER BY A.CREATE_DATE DESC
    </select>

    <insert id="insertAttend" parameterType="DeviceRentAtt">
        <selectKey keyProperty="deviceRentAttId" resultType="_int" order="BEFORE">
            SELECT SEQ_DRANO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO DEVICE_RENT_ATT (
        RENT_ATT_NO,
        CREATE_DATE,
        START_DATE,
        END_DATE,
        ATTEND_COUNT,
        DEVICE_ID,
        MEMBER_NO
        )
        VALUES (
        #{deviceRentAttId},
        SYSDATE,
        SYSDATE,
        #{endTime},
        #{attendAmount},
        #{deviceId},
        #{memberNo}
        )
    </insert>
    <select id="selectBoardListCount" resultType="_int">
        SELECT COUNT(*)
        FROM DEVICE_RENT_ATT
        WHERE STATUS = 'WAIT'
    </select>
    <select id="selectAttendListCount" resultType="_int">
        SELECT COUNT(*)
        FROM DEVICE_RENT_ATT
    </select>

<!--    <select id="selectDeviceRentAtth" resultMap="deviceRentAttResultMap">-->
<!--        SELECT-->
<!--        A.RENT_ATT_NO,        &#45;&#45; DeviceRentAttId-->
<!--        A.CREATE_DATE,        &#45;&#45; CreateTime-->
<!--        A.START_DATE,         &#45;&#45; StartTime-->
<!--        A.END_DATE,           &#45;&#45; EndTime-->
<!--        A.UPDATE_DATE,        &#45;&#45; UpdateTime-->
<!--        A.ATTEND_COUNT,       &#45;&#45; AttendAmount-->
<!--        A.STATUS,             &#45;&#45; Status-->
<!--        A.DEVICE_ID,          &#45;&#45; DeviceId (외래키)-->
<!--        A.MEMBER_NO,          &#45;&#45; MemberId (외래키)-->
<!--        D.DEVICE_KIND,        &#45;&#45; DeviceKind-->
<!--        M.MEMBER_NAME         &#45;&#45; 신청자 이름-->
<!--        FROM DEVICE_RENT_ATT A-->
<!--        JOIN DEVICE D ON A.DEVICE_ID = D.DEVICE_ID-->
<!--        JOIN MEMBER M ON A.MEMBER_NO = M.MEMBER_NO-->
<!--        ORDER BY A.CREATE_DATE DESC-->
<!--    </select>-->

    <update id="updateDeviceStatus" parameterType="map">
        UPDATE DEVICE_RENT_ATT
        SET STATUS = #{status}, UPDATE_DATE = SYSDATE
        WHERE RENT_ATT_NO = #{deviceRentAttId}
    </update>
    <select id="selectBoardList" resultMap="deviceRentAttResultMap">
        SELECT
        A.RENT_ATT_NO,        -- DeviceRentAttId
        A.CREATE_DATE,        -- CreateTime
        A.START_DATE,         -- StartTime
        A.END_DATE,           -- EndTime
        A.UPDATE_DATE,        -- UpdateTime
        A.ATTEND_COUNT,       -- AttendAmount
        A.STATUS,             -- Status
        A.DEVICE_ID,          -- DeviceId (외래키)
        A.MEMBER_NO,          -- MemberId (외래키)
        D.DEVICE_KIND,        -- DeviceKind
        M.MEMBER_NAME         -- 신청자 이름
        FROM DEVICE_RENT_ATT A
        JOIN DEVICE D ON A.DEVICE_ID = D.DEVICE_ID
        JOIN MEMBER M ON A.MEMBER_NO = M.MEMBER_NO
        WHERE A.STATUS = 'WAIT'
        ORDER BY A.CREATE_DATE DESC
    </select>

    <select id="selectAttendList" resultMap="deviceRentAttResultMap">
        SELECT
        A.RENT_ATT_NO,        -- DeviceRentAttId
        A.CREATE_DATE,        -- CreateTime
        A.START_DATE,         -- StartTime
        A.END_DATE,           -- EndTime
        A.UPDATE_DATE,        -- UpdateTime
        A.ATTEND_COUNT,       -- AttendAmount
        A.STATUS,             -- Status
        A.DEVICE_ID,          -- DeviceId (외래키)
        A.MEMBER_NO,          -- MemberId (외래키)
        D.DEVICE_KIND,        -- DeviceKind
        M.MEMBER_NAME         -- 신청자 이름
        FROM DEVICE_RENT_ATT A
        JOIN DEVICE D ON A.DEVICE_ID = D.DEVICE_ID
        JOIN MEMBER M ON A.MEMBER_NO = M.MEMBER_NO
        ORDER BY A.CREATE_DATE DESC
    </select>

    <select id="selectDeviceStatusList" resultMap="deviceStatusResultMap">
        SELECT
        D.DEVICE_ID,
        D.DEVICE_KIND,
        D.DEVICE_COUNT,
        D.STATUS,
        (D.DEVICE_COUNT - NVL(SUM(
        CASE WHEN DL.RETURN_DATE IS NULL THEN DL.DEVICE_CNT ELSE 0 END
        ), 0)) AS DEVICE_REMAIN
        FROM DEVICE D
        LEFT JOIN DEVICE_RENT_ATT dra ON D.DEVICE_ID = dra.DEVICE_ID
        LEFT JOIN DEVICE_LOG DL ON dra.RENT_ATT_NO = DL.RENT_ATT_NO
        GROUP BY D.DEVICE_ID, D.DEVICE_KIND, D.DEVICE_COUNT, D.STATUS
        ORDER BY D.DEVICE_ID
    </select>


<!--    <update id="decreaseDeviceCount">-->
<!--        UPDATE DEVICE d-->
<!--        SET d.DEVICE_COUNT = d.DEVICE_COUNT - (-->
<!--        SELECT dra.ATTEND_COUNT-->
<!--        FROM DEVICE_RENT_ATT dra-->
<!--        WHERE dra.RENT_ATT_NO = #{rentAttNo}-->
<!--        )-->
<!--        WHERE d.DEVICE_ID = (-->
<!--        SELECT dra.DEVICE_ID-->
<!--        FROM DEVICE_RENT_ATT dra-->
<!--        WHERE dra.RENT_ATT_NO = #{rentAttNo}-->
<!--        )-->
<!--        AND d.DEVICE_COUNT >= (-->
<!--        SELECT dra.ATTEND_COUNT-->
<!--        FROM DEVICE_RENT_ATT dra-->
<!--        WHERE dra.RENT_ATT_NO = #{rentAttNo}-->
<!--        )-->
<!--    </update>-->


    <select id="getDeviceListWithRemain" resultMap="deviceStatusResultMap">
        SELECT
        D.DEVICE_ID,
        D.DEVICE_KIND,
        D.DEVICE_COUNT,
        D.STATUS,
        (D.DEVICE_COUNT - NVL(SUM(
        CASE WHEN DL.RETURN_DATE IS NULL THEN DL.DEVICE_CNT ELSE 0 END
        ), 0)) AS DEVICE_REMAIN
        FROM DEVICE D
        LEFT JOIN DEVICE_RENT_ATT dra ON D.DEVICE_ID = dra.DEVICE_ID
        LEFT JOIN DEVICE_LOG DL ON dra.RENT_ATT_NO = DL.RENT_ATT_NO
        GROUP BY D.DEVICE_ID, D.DEVICE_KIND, D.DEVICE_COUNT, D.STATUS
        ORDER BY D.DEVICE_ID
    </select>


    <update id="insertDeviceLog" parameterType="int">
        INSERT INTO DEVICE_LOG (
        DEVICE_LOG_NO,
        MEMBER_NO,
        RENT_ATT_NO,
        DEVICE_CNT
        )
        SELECT
        SEQ_DLNO.NEXTVAL,
        dra.MEMBER_NO,
        dra.RENT_ATT_NO,
        dra.ATTEND_COUNT
        FROM DEVICE_RENT_ATT dra
        WHERE dra.RENT_ATT_NO = #{deviceRentAttId}
    </update>
    <select id="getDeviceRentAttById" resultMap="getDeviceRentAttById">
        SELECT ATTEND_COUNT, DEVICE_ID, MEMBER_NO
        FROM DEVICE_RENT_ATT
        WHERE RENT_ATT_NO = #{deviceRentAttId}
    </select>

    <select id="getDeviceRemain" resultType="int">
        SELECT DEVICE_REMAIN
        FROM DEVICE
        WHERE DEVICE_ID = #{deviceId}
    </select>

<!--    <insert id="insertDeviceLog">-->
<!--        INSERT INTO DEVICE_LOG (RENT_ATT_NO, DEVICE_CNT, CREATE_DATE)-->
<!--        VALUES (#{rentAttNo}, #{attendAmount}, SYSDATE)-->
<!--    </insert>-->
    <update id="updateDeviceRemain">
        UPDATE DEVICE
        SET DEVICE_REMAIN = DEVICE_REMAIN - #{attendAmount}
        WHERE DEVICE_ID = #{deviceId} AND DEVICE_REMAIN >= #{attendAmount}
    </update>
</mapper>