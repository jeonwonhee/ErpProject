<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.classLink.model.mapper.LectureDateMapper">

    <!-- ===============================
         ResultMap
         =============================== -->
    <resultMap id="lectureDateResultMap" type="LectureDate">
        <id column="LECTURE_DATE_NO" property="lectureDateNo"/>
        <result column="START_DATE" property="startDate"/>
        <result column="END_DATE" property="endDate"/>
        <result column="TITLE" property="title"/>
        <result column="CONTENT" property="content"/>
        <result column="CLASS_LECTURE_NO" property="classLectureNo"/>
        <result column="DATE_TYPE" property="dateType"/>
        <result column="STATUS" property="status"/>
    </resultMap>

    <!-- ===============================
         1) 전체 일정 조회
         =============================== -->
    <select id="selectLectureDateList" resultMap="lectureDateResultMap">
        SELECT
            L.LECTURE_DATE_NO,
            TO_CHAR(L.START_DATE, 'YYYY-MM-DD') AS START_DATE,
            TO_CHAR(L.END_DATE, 'YYYY-MM-DD') AS END_DATE,
            L.TITLE,
            L.CONTENT,
            L.CLASS_LECTURE_NO,
            L.DATE_TYPE,
            NVL(A.STATUS, 'IN_PROGRESS') AS STATUS
        FROM LECTURE_DATE L
        LEFT JOIN LECTURE_DATE_APPROVAL A
            ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
        WHERE L.CLASS_LECTURE_NO = #{classLectureNo}
        ORDER BY L.START_DATE ASC
    </select>

    <!-- ===============================
         2) 특정 반(CLASS_LECTURE_NO)의 일정 조회
         =============================== -->
    <select id="selectLectureDateByClass" parameterType="int" resultType="ClassLecture">
        SELECT
            CAST(CL.CLASS_LECTURE_NO AS INTEGER) AS classLectureNo,
            C.CLASS_NAME AS className
        FROM CLASS_LECTURE CL
        JOIN LECTURE L ON CL.LECTURE_NO = L.LECTURE_NO
        JOIN CLASS C ON CL.CLASS_NO = C.CLASS_NO
        WHERE L.MEMBER_NO = #{memberNo}
    </select>

    <!-- ===============================
         3) 일정 추가 (수업일정 / 휴강)
         =============================== -->
    <insert id="insertLectureDate" parameterType="LectureDate">
        <selectKey keyProperty="lectureDateNo" resultType="_int" order="BEFORE">
            SELECT SEQ_LDNO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO LECTURE_DATE (
            LECTURE_DATE_NO,
            START_DATE,
            END_DATE,
            TITLE,
            CONTENT,
            CLASS_LECTURE_NO,
            DATE_TYPE
        ) VALUES (
            #{lectureDateNo},
            #{startDate},
            #{endDate},
            #{title},
            #{content},
            #{classLectureNo},
            #{dateType}
        )
    </insert>

    <!-- ===============================
         4) 일정 수정
         =============================== -->
    <update id="updateLectureDate" parameterType="LectureDate">
        UPDATE LECTURE_DATE
        SET START_DATE = #{startDate},
            END_DATE = #{endDate},
            TITLE = #{title},
            CONTENT = #{content},
            DATE_TYPE = #{dateType}
        WHERE LECTURE_DATE_NO = #{lectureDateNo}
    </update>

    <!-- ===============================
         5) 일정 삭제
         =============================== -->
    <delete id="deleteLectureDate" parameterType="int">
        DELETE FROM LECTURE_DATE
        WHERE LECTURE_DATE_NO = #{lectureDateNo}
    </delete>

    <!-- 일정 등록 후 승인 테이블 자동 생성 -->
    <insert id="insertLectureDateApproval">
        INSERT INTO LECTURE_DATE_APPROVAL (
            APPROVAL_NO,
            LECTURE_DATE_NO
        )
        VALUES (
            SEQ_LDANO.NEXTVAL,
            #{lectureDateNo}
        )
    </insert>

    <!-- 승인 상태 업데이트 -->
    <update id="updateApprovalStatus">
        UPDATE LECTURE_DATE_APPROVAL
        SET STATUS = #{status},
            APPROVAL_REJECT = #{reason},
            APPROVED_BY = #{approvedBy},
            APPROVAL_DATE = SYSDATE
        WHERE LECTURE_DATE_NO = #{lectureDateNo}
    </update>

    <select id="selectLectureDateApprovalList" resultType="LectureDateApprovalList">
        SELECT
            L.LECTURE_DATE_NO AS lectureDateNo,
            L.TITLE,
            M.MEMBER_NAME AS WRITER,
            L.START_DATE,
            L.END_DATE,
            A.STATUS,
            TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS approvalDate
        FROM LECTURE_DATE L
        JOIN LECTURE_DATE_APPROVAL A
            ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
        JOIN CLASS_LECTURE CL
            ON L.CLASS_LECTURE_NO = CL.CLASS_LECTURE_NO
        JOIN MEMBER M
            ON CL.LECTURE_NO = M.MEMBER_NO
        ORDER BY A.APPROVAL_DATE DESC
    </select>

    <select id="selectLectureDateListPaged" parameterType="map" resultType="LectureDateApprovalList">
        SELECT *
        FROM (
        SELECT ROWNUM AS RNUM, A.*
        FROM (
            SELECT
                L.LECTURE_DATE_NO AS lectureDateNo,
                L.TITLE AS title,
                M.MEMBER_NAME AS writer,
                TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS approvalDate,
                A.STATUS AS status
            FROM LECTURE_DATE L
            JOIN LECTURE_DATE_APPROVAL A
                ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
            JOIN CLASS_LECTURE CL
                ON L.CLASS_LECTURE_NO = CL.CLASS_LECTURE_NO
            JOIN MEMBER M
                ON CL.LECTURE_NO = M.MEMBER_NO
            ORDER BY L.LECTURE_DATE_NO DESC
        ) A
        WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE RNUM &gt; #{startRow}
    </select>

    <select id="getLectureDateListCount" resultType="int">
        SELECT COUNT(*)
        FROM LECTURE_DATE_APPROVAL
    </select>

    <select id="selectLectureDateApprovalDetail" parameterType="int" resultType="LectureDateApprovalList">
        SELECT
            L.LECTURE_DATE_NO AS lectureDateNo,
            L.TITLE AS title,
            L.CONTENT AS content,
            TO_CHAR(L.START_DATE, 'YYYY-MM-DD') AS startDate,
            TO_CHAR(L.END_DATE, 'YYYY-MM-DD') AS endDate,
            M.MEMBER_NAME AS writer,
            A.STATUS AS status,
            TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS approvalDate,
            A.APPROVAL_REJECT AS rejectReason
        FROM LECTURE_DATE L
        JOIN CLASS_LECTURE CL
            ON L.CLASS_LECTURE_NO = CL.CLASS_LECTURE_NO
        JOIN LECTURE LC
            ON CL.LECTURE_NO = LC.LECTURE_NO
        JOIN MEMBER M
            ON LC.MEMBER_NO = M.MEMBER_NO
        JOIN LECTURE_DATE_APPROVAL A
            ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
        WHERE L.LECTURE_DATE_NO = #{lectureDateNo}
    </select>

    <select id="getLectureDateCount" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM LECTURE_DATE
        WHERE CLASS_LECTURE_NO = #{classLectureNo}
    </select>

    <select id="selectLectureDatePaged" parameterType="map" resultType="LectureDate">
        SELECT *
        FROM (
            SELECT ROWNUM AS RNUM,
            T.*
            FROM (
                SELECT
                    L.LECTURE_DATE_NO,
                    TO_CHAR(L.START_DATE, 'YYYY-MM-DD') AS startDate,
                    TO_CHAR(L.END_DATE, 'YYYY-MM-DD') AS endDate,
                    L.TITLE,
                    L.CONTENT,
                    L.DATE_TYPE,
                    NVL(A.STATUS, 'IN_PROGRESS') AS STATUS
                FROM LECTURE_DATE L
                LEFT JOIN LECTURE_DATE_APPROVAL A
                    ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
                WHERE CLASS_LECTURE_NO = #{classLectureNo}
                ORDER BY START_DATE ASC
            ) T
            WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE RNUM &gt; #{startRow}
    </select>

    <!-- ===============================
     학생용 일정 조회 (자신의 반 일정)
     =============================== -->
    <select id="selectLectureDateListStudent"
            parameterType="int"
            resultMap="lectureDateResultMap">

        SELECT
            L.LECTURE_DATE_NO,
            TO_CHAR(L.START_DATE, 'YYYY-MM-DD') AS START_DATE,
            TO_CHAR(L.END_DATE, 'YYYY-MM-DD') AS END_DATE,
            L.TITLE,
            L.CONTENT,
            L.CLASS_LECTURE_NO,
            L.DATE_TYPE,
            A.STATUS
        FROM LECTURE_DATE L
        JOIN LECTURE_DATE_APPROVAL A
            ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
        JOIN CLASS_LECTURE CL
            ON L.CLASS_LECTURE_NO = CL.CLASS_LECTURE_NO
        JOIN CLASS C
            ON CL.CLASS_NO = C.CLASS_NO
        JOIN CLASS_STUDENT CS
            ON C.CLASS_NO = CS.CLASS_NO
        WHERE CS.MEMBER_NO = #{memberNo}
        ORDER BY L.START_DATE DESC
    </select>

    <!-- 학생이 속한 반 이름 조회 -->
    <select id="selectClassNameByStudent" parameterType="int" resultType="string">
        SELECT C.CLASS_NAME
        FROM CLASS C
        JOIN CLASS_STUDENT CS ON C.CLASS_NO = CS.CLASS_NO
        WHERE CS.MEMBER_NO = #{memberNo}
    </select>

</mapper>
