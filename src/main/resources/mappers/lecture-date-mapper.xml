<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.classLink.model.mapper.LectureDateMapper">

    <!-- ===============================
         ResultMap
         =============================== -->
    <resultMap id="lectureDateResultMap" type="LectureDate">
        <id column="LECTURE_DATE_NO" property="lectureDateNo"/>
        <result column="START_DATE" property="startDate"/>
        <result column="END_DATE" property="endDate"/>
        <result column="TITLE" property="title"/>
        <result column="CONTENT" property="content"/>
        <result column="CLASS_LECTURE_NO" property="classLectureNo"/>
        <result column="DATE_TYPE" property="dateType"/>
    </resultMap>

    <!-- ===============================
         1) 전체 일정 조회
         =============================== -->
<!--    <select id="selectLectureDateList" resultMap="lectureDateResultMap">-->
<!--        SELECT-->
<!--            LECTURE_DATE_NO,-->
<!--            TO_CHAR(START_DATE, 'YYYY-MM-DD') AS START_DATE,-->
<!--            TO_CHAR(END_DATE, 'YYYY-MM-DD') AS END_DATE,-->
<!--            TITLE,-->
<!--            CONTENT,-->
<!--            CLASS_LECTURE_NO,-->
<!--            DATE_TYPE-->
<!--        FROM LECTURE_DATE-->
<!--        ORDER BY START_DATE DESC-->
<!--    </select>-->

    <select id="selectLectureDateList" resultMap="lectureDateResultMap">
        SELECT
            L.LECTURE_DATE_NO,
            TO_CHAR(L.START_DATE, 'YYYY-MM-DD') AS START_DATE,
            TO_CHAR(L.END_DATE, 'YYYY-MM-DD') AS END_DATE,
            L.TITLE,
            L.CONTENT,
            L.CLASS_LECTURE_NO,
            L.DATE_TYPE,
            A.STATUS
        FROM
            LECTURE_DATE L
        JOIN
            LECTURE_DATE_APPROVAL A
        ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
        WHERE
            L.CLASS_LECTURE_NO = #{memberNo}
        ORDER BY
            L.START_DATE DESC
    </select>

    <!-- ===============================
         2) 특정 반(CLASS_LECTURE_NO)의 일정 조회
         =============================== -->
    <select id="selectLectureDateByClass" resultMap="lectureDateResultMap" parameterType="int">
        SELECT
            LECTURE_DATE_NO,
            TO_CHAR(START_DATE, 'YYYY-MM-DD') AS START_DATE,
            TO_CHAR(END_DATE, 'YYYY-MM-DD') AS END_DATE,
            TITLE,
            CONTENT,
            CLASS_LECTURE_NO,
            DATE_TYPE
        FROM LECTURE_DATE
        WHERE CLASS_LECTURE_NO = #{classLectureNo}
        ORDER BY START_DATE DESC
    </select>

    <!-- ===============================
         3) 일정 추가 (수업일정 / 휴강)
         =============================== -->
    <insert id="insertLectureDate" parameterType="LectureDate">
        <selectKey keyProperty="lectureDateNo" resultType="_int" order="BEFORE">
            SELECT SEQ_LDNO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO LECTURE_DATE (
            LECTURE_DATE_NO,
            START_DATE,
            END_DATE,
            TITLE,
            CONTENT,
            CLASS_LECTURE_NO,
            DATE_TYPE
        ) VALUES (
            #{lectureDateNo},
            #{startDate},
            #{endDate},
            #{title},
            #{content},
            #{classLectureNo},
            #{dateType}
        )
    </insert>

    <!-- ===============================
         4) 일정 수정
         =============================== -->
    <update id="updateLectureDate" parameterType="LectureDate">
        UPDATE LECTURE_DATE
        SET START_DATE = #{startDate},
            END_DATE = #{endDate},
            TITLE = #{title},
            CONTENT = #{content},
            DATE_TYPE = #{dateType}
        WHERE LECTURE_DATE_NO = #{lectureDateNo}
    </update>

    <!-- ===============================
         5) 일정 삭제
         =============================== -->
    <delete id="deleteLectureDate" parameterType="int">
        DELETE FROM LECTURE_DATE
        WHERE LECTURE_DATE_NO = #{lectureDateNo}
    </delete>

    <!-- 로그인한 강사의 담당 반번호 조회 -->
    <select id="selectClassLectureNoByMemberNo" parameterType="int" resultType="int">
        SELECT CL.CLASS_LECTURE_NO
        FROM CLASS_LECTURE CL
        JOIN LECTURE L ON CL.LECTURE_NO = L.LECTURE_NO
        WHERE L.MEMBER_NO = #{memberNo}
    </select>

    <!-- 일정 등록 후 승인 테이블 자동 생성 -->
    <insert id="insertLectureDateApproval">
        INSERT INTO LECTURE_DATE_APPROVAL (
            APPROVAL_NO,
            LECTURE_DATE_NO
        )
        VALUES (
            SEQ_LDANO.NEXTVAL,
            #{lectureDateNo}
        )
    </insert>

    <!-- 승인 상태 업데이트 -->
    <update id="updateApprovalStatus">
        UPDATE LECTURE_DATE_APPROVAL
        SET STATUS = #{status},
            APPROVAL_REJECT = #{reason},
            APPROVED_BY = #{approvedBy},
            APPROVAL_DATE = SYSDATE
        WHERE LECTURE_DATE_NO = #{lectureDateNo}
    </update>

    <select id="selectLectureDateApprovalList" resultType="LectureDateApprovalList">
        SELECT
            L.LECTURE_DATE_NO AS lectureDateNo,
            L.TITLE,
            M.MEMBER_NAME AS WRITER,
            L.START_DATE,
            L.END_DATE,
            A.STATUS,
            TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS approvalDate
        FROM LECTURE_DATE L
        JOIN MEMBER M ON L.CLASS_LECTURE_NO = M.MEMBER_NO
        JOIN LECTURE_DATE_APPROVAL A ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
        ORDER BY A.APPROVAL_DATE DESC
    </select>

    <select id="selectLectureDateListPaged" parameterType="map" resultType="LectureDateApprovalList">
        SELECT *
        FROM (
        SELECT ROWNUM AS RNUM, A.*
        FROM (
            SELECT
                L.LECTURE_DATE_NO AS lectureDateNo,
                L.TITLE AS title,
                M.MEMBER_NAME AS writer,
                TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS approvalDate,
                A.STATUS AS status
            FROM LECTURE_DATE L
            JOIN LECTURE_DATE_APPROVAL A
                ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
            JOIN CLASS_LECTURE CL
                ON L.CLASS_LECTURE_NO = CL.CLASS_LECTURE_NO
            JOIN MEMBER M
                ON CL.LECTURE_NO = M.MEMBER_NO
            ORDER BY L.LECTURE_DATE_NO DESC
        ) A
        WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE RNUM &gt; #{startRow}
    </select>

    <select id="getLectureDateListCount" resultType="int">
        SELECT COUNT(*)
        FROM LECTURE_DATE_APPROVAL
    </select>

    <select id="selectLectureDateApprovalDetail" parameterType="int" resultType="LectureDateApprovalList">
        SELECT
            L.LECTURE_DATE_NO AS lectureDateNo,
            L.TITLE AS title,
            L.CONTENT AS content,
            TO_CHAR(L.START_DATE, 'YYYY-MM-DD') AS startDate,
            TO_CHAR(L.END_DATE, 'YYYY-MM-DD') AS endDate,
            M.MEMBER_NAME AS writer,
            A.STATUS AS status,
            TO_CHAR(A.APPROVAL_DATE, 'YYYY-MM-DD') AS approvalDate,
            A.APPROVAL_REJECT AS rejectReason
        FROM LECTURE_DATE L
        JOIN MEMBER M ON L.CLASS_LECTURE_NO = M.MEMBER_NO
        JOIN LECTURE_DATE_APPROVAL A ON L.LECTURE_DATE_NO = A.LECTURE_DATE_NO
        WHERE L.LECTURE_DATE_NO = #{lectureDateNo}
    </select>


</mapper>
