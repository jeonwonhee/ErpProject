<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.classLink.model.mapper.CommuteMapper">

    <!-- 로그인 시 출근 등록 -->
    <insert id="insertCommuteIn">
        INSERT INTO COMMUTE (
        COMMUTE_NO,
        MEMBER_NO,
        COMMUTE_STATUS,
        COMMUTE_DATE,
        CREATE_DATE
        ) VALUES (
        SEQ_CMNO.NEXTVAL,
        #{memberNo},
        #{status},
        SYSDATE,
        SYSDATE
        )
    </insert>

    <!-- 오늘 출근 여부 -->
    <select id="checkTodayCommute" resultType="int">
        SELECT COUNT(*)
        FROM COMMUTE
        WHERE MEMBER_NO = #{memberNo}
        AND TRUNC(COMMUTE_DATE) = TRUNC(SYSDATE)
    </select>

    <!-- 가장 최근 출근 기록 조회 (퇴근 처리 가능 상태만) -->
    <select id="selectLatestCommute" resultType="com.kh.classLink.model.vo.Commute" parameterType="int">
        SELECT *
        FROM COMMUTE
        WHERE MEMBER_NO = #{memberNo}
        AND REPLACE(UPPER(TRIM(COMMUTE_STATUS)), CHR(10), '') IN ('IN', 'LATE')
        ORDER BY COMMUTE_NO DESC
        FETCH FIRST 1 ROWS ONLY
    </select>
    <!-- 퇴근 OUT 처리 -->
    <update id="updateCommuteOut">
        UPDATE COMMUTE
        SET COMMUTE_STATUS = 'OUT',
        UPDATE_DATE = SYSDATE
        WHERE COMMUTE_NO = #{commuteNo}
    </update>

</mapper>